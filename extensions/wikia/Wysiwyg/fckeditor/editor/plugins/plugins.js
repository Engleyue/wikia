/*
 * FCKeditor - The text editor for Internet - http://www.fckeditor.net
 * Copyright (C) 2003-2009 Frederico Caldeira Knabben
 *
 * == BEGIN LICENSE ==
 *
 * Licensed under the terms of any of the following licenses at your
 * choice:
 *
 *  - GNU General Public License Version 2 or later (the "GPL")
 *    http://www.gnu.org/licenses/gpl.html
 *
 *  - GNU Lesser General Public License Version 2.1 or later (the "LGPL")
 *    http://www.gnu.org/licenses/lgpl.html
 *
 *  - Mozilla Public License Version 1.1 or later (the "MPL")
 *    http://www.mozilla.org/MPL/MPL-1.1.html
 *
 * == END LICENSE ==
 *
 * This file has been compressed for better performance. The original source
 * can be found at "editor/_source".
 */

FCKCommands.RegisterCommand('Link',new FCKDialogCommand('Link',FCKLang.DlgLnkWindowTitle,FCKConfig.PluginsPath+'wikitext/dialogs/link.html',400,250));FCK.TemplateClickCommand=new FCKDialogCommand('Template','&nbsp;',FCKConfig.PluginsPath+'wikitext/dialogs/template.html',780,490);var FCKTildesCommand=function() {this.Name='Tildes';};FCKTildesCommand.prototype={Execute:function() {FCKUndo.SaveUndoStep();var A=FCK.EditorDocument.createTextNode('--');FCK.InsertElement(A);var B=FCK.GetFreeRefId();FCK.wysiwygData[B]={'type':'tilde','description':'~~~~'};var C=FCK.EditorDocument.createElement('input');C.value="~~~~";C.className='wysiwygDisabled';C.type='button';C.setAttribute('refid',B);FCK.InsertElement(C);},GetState:function() {if (FCK.EditMode!=0) return -1;return 0;}};FCKCommands.RegisterCommand('Tildes',new FCKTildesCommand());var oTildesItem=new FCKToolbarButton('Tildes','Add your signature');oTildesItem.IconPath=FCKConfig.PluginsPath+'wikitext/sig.gif';FCKToolbarItems.RegisterItem('Tildes',oTildesItem);var FCKAddImageCommand=function() {this.Name='AddImage';};FCKAddImageCommand.prototype={Execute:function() {FCKUndo.SaveUndoStep();FCK.log('opening "add image" dialog');window.parent.WMU_show(-1);},GetState:function() {if (FCK.EditMode!=0) return -1;return 0;}};FCKCommands.RegisterCommand('AddImage',new FCKAddImageCommand());var oTildesItem=new FCKToolbarButton('AddImage','Add image');oTildesItem.IconPath=FCKConfig.PluginsPath+'wikitext/addImage.png';FCKToolbarItems.RegisterItem('AddImage',oTildesItem);FCK.ToggleEditButtons=function(A) {var B=['wpSave','wpPreview','wpDiff'];for (b=0;b<B.length;b++) {window.parent.document.getElementById(B[b]).disabled=A;}};FCK.EditorInstanceId=(new Date()).getTime();FCK.LoadTime=false;FCK.onWysiwygLoad=function() {if (FCK.LoadTime==false) {FCK.ToggleEditButtons(false);FCK.log('Save / preview / show changes buttons have been unblocked');FCK.log('FCKeditor v'+window.parent.FCKeditorAPI.Version+' (build '+window.parent.FCKeditorAPI.VersionBuild+')');if (typeof window.parent.wgNow=='undefined') {FCK.log('loaded (wgNow not defined!)');FCK.LoadTime=true;return;};FCK.LoadTime=((new Date()).getTime()-window.parent.wgNow.getTime())/1000;FCK.log('loaded in '+FCK.LoadTime+' s');}};FCK.originalSwitchEditMode=FCK.SwitchEditMode;FCK.WysiwygSwitchToolbars=function(A) {var B=FCK.ToolbarSet.Toolbars[0];B.WikiaSwitchToolbar(A);};FCK.SwitchEditMode=function() {if(FCK.InProgress==true) {return true;};FCK.InProgress=true;FCK.ToggleEditButtons(true);var A=arguments;if(FCK.EditMode==0) {FCK.EditingArea.TargetElement.className='childrenHidden';FCK.originalSwitchEditMode.apply(FCK,A);} else if(FCK.EditMode==1) {FCK.EditingArea.TargetElement.className='childrenHidden';window.parent.sajax_request_type='POST';window.parent.sajax_do_call('Wysywig_Ajax',['wiki2html',FCK.EditingArea.Textarea.value,false,window.parent.wgPageName],function(E) {var B=E.getResponseHeader('X-edgecases');if(typeof B=="undefined") B=E.getResponseHeader('X-Edgecases');if (B=='1'||window.parent.noWysiwygMagicWordMsg) {messages=window.parent.noWysiwygMagicWordMsg||E.responseText;if (FCK.EditingArea.Textarea.value.indexOf('<!--')>-1) {FCK.Track('/wikitext_comment/popup');};alert(messages);} else {var C=E.getResponseHeader('X-sep');if(typeof C=="undefined") C=E.getResponseHeader('X-Sep');var D=E.responseText.split('--'+C+'--');FCK.wysiwygData=eval("{"+D[1]+"}");if(!FCK.wysiwygData) {FCK.wysiwygData=[];};FCK.EditingArea.Textarea.value=D[0];FCK.originalSwitchEditMode.apply(FCK,A);FCK.WysiwygSwitchToolbars(false);if (FCK.Track) FCK.Track('/switchMode/wiki2html');window.parent.document.getElementById('wysiwygTemporarySaveType').value="0";};FCK.EditingArea.TargetElement.className='';setTimeout(function() {FCK.InProgress=false;},100);FCK.ToggleEditButtons(false);FCK.EditingArea.Focus();});};return true;};FCK.ArrayIndexOf=function(A,B){for (var i=0;i<A.length;i++){if (A[i]==B) return i;};return-1;};FCK.InsertDirtySpanBefore=function(A) {var B=FCKTools.GetElementDocument(A).createElement('SPAN');B.setAttribute('type','_moz');B.className='_moz_dirty';A.parentNode.insertBefore(B,A);};FCK.InsertDirtySpanAfter=function(A) {var B=FCKTools.GetElementDocument(A).createElement('SPAN');B.setAttribute('type','_moz');B.className='_moz_dirty';FCKDomTools.InsertAfterNode(A,B);};FCK.SetMetaData=function(A,B) {A=parseInt(A);FCK.wysiwygData[A]=FCK.jQuery().extend(true,FCK.wysiwygData[A],B);};FCK.GetMetaData=function(A) {A=parseInt(A);return FCK.wysiwygData[A];};FCK.AddMetaData=function(A,B,C) {A=parseInt(A);FCK.SetMetaData(A,C);FCK.NodesWithRefId[A]=B;};FCK.DeleteMetaData=function(A) {A=parseInt(A);delete FCK.wysiwygData[A];delete FCK.NodesWithRefId[A];};FCK.GetFreeRefId=function() {var A=0;for (r in FCK.wysiwygData) {r=parseInt(r);if (A<r) {A=r;}};return++A;};FCK.GetElementByRefId=function(A) {return FCK.NodesWithRefId[A];};FCK.NodesWithRefId={};FCK.GetNodesWithRefId=function() {var A=[];FCK.NodesWithRefId={};if (FCKBrowserInfo.IsIE) {var B=function(F) {return (F.getAttribute('refid')!=undefined);};var C=function(G) {FCK.NodesWithRefId[G.getAttribute('refid')]=G;};var A=FCK.YD.getElementsBy(B,false,FCK.EditorDocument.body,C);}else {var E=FCK.EditorDocument.evaluate('//@refid',FCK.EditorDocument,null,XPathResult.ANY_TYPE,null);while (attr=E.iterateNext()) {node=attr.ownerElement;A.push(node);FCK.NodesWithRefId[node.getAttribute('refid')]=node;}};FCK.log('returning '+A.length+' nodes with refId');return A;};FCK.BlockEvent=function(A,B) {FCKTools.AddEventListener(A,B,function(e) {FCK.YE.stopEvent(FCK.YE.getEvent(e));});};FCK.Events.AttachEvent('OnAfterSetHTML',function() {if(FCK.EditingArea.TargetElement.className=='childrenHidden') {var A=FCK.GetData();var B=FCK.YAHOO.Tools.JSONEncode(FCK.wysiwygData);FCK.log(FCK.wysiwygData);window.parent.sajax_request_type='POST';window.parent.sajax_do_call('Wysywig_Ajax',['html2wiki',A,B],function(L) {FCK.EditingArea.Textarea.value=L.responseText;FCK.EditingArea.TargetElement.className='';setTimeout(function() {FCK.InProgress=false;},100);FCK.EditingArea.Focus();FCK.WysiwygSwitchToolbars(true);if (FCK.Track) FCK.Track('/switchMode/html2wiki');window.parent.document.getElementById('wysiwygTemporarySaveType').value="1";FCK.ToggleEditButtons(false);});};if(!FCK.wysiwygData) {FCK.wysiwygData=eval("{"+window.parent.document.getElementById('wysiwygData').value+"}");if(!FCK.wysiwygData) {FCK.wysiwygData=[];};FCK.log(FCK.wysiwygData);};if(FCK.EditMode==0) {FCKTools.AddEventListener(FCK.EditorDocument,'mousedown',function(e) {var C=FCK.YAHOO.util.Event.getTarget(e);if(C.tagName=='INPUT') {FCKSelection.SelectNode(C);}});FCK.DragNDropInProgress=false;FCK.DragNDropUndoStep={};FCKTools.AddEventListener(FCK.EditorDocument,'drag',function(e) {if (!FCK.DragNDropInProgress) {FCK.log('drag&drop started - saved undo step');FCK.DragNDropInProgress=true;FCK.DragNDropUndoStep={A:FCK.EditorDocument.body.innerHTML,cursor:FCKUndo._GetBookmark()};}});FCKTools.AddEventListener(FCK.EditorDocument,'dragdrop',function(e) {FCK.DragNDropInProgress=false;FCK.SetupElementsWithRefId();var C=FCK.YE.getTarget(e);var E=FCKSelection.GetSelection();if (C.getAttribute&&C.getAttribute('contentEditable')=="false") {FCK.log('prohibited drag&drop detected - undo');FCK.EditorDocument.body.innerHTML=FCK.DragNDropUndoStep.html;FCKUndo._SelectBookmark(FCK.DragNDropUndoStep.cursor);FCK.SetupElementsWithRefId();FCK.Events.FireEvent("OnSelectionChange");};if (FCK.ImageDragDrop&&!FCK.GetElementByRefId(FCK.ImageDragDrop.getAttribute('refid'))) {FCK.log('adding image back to editing area');FCK.EditorDocument.body.appendChild(FCK.ImageDragDrop);FCK.SetupElementsWithRefId();};if (FCKBrowserInfo.IsGecko19&&FCK.ImageDragDrop) {var A=FCK.EditorDocument.body.innerHTML;FCK.EditorDocument.body.innerHTML=A;FCK.SetupElementsWithRefId();};FCK.DragNDropUndoStep={};if (E.removeAllRanges) {E.removeAllRanges();};FCK.ImageDragDrop=false;});if (FCKBrowserInfo.IsIE) {FCK.EditorDocument.body.ondrop=function(e) {FCK.log('drag&drop finished');FCK.SetupElementsWithRefId();};};FCKTools.AddEventListener(FCK.EditorDocument,'click',function(e) {var C=FCK.YAHOO.util.Event.getTarget(e);if(C.tagName=='INPUT') {var H=C.getAttribute('refid');var I=C.getAttribute('_fck_type');if(H&&I!='template') {if (FCK.Track&&FCK.wysiwygData) {FCK.Track('/wikitextbox/'+(FCK.wysiwygData[H]?FCK.wysiwygData[H].type:'unknown'));};FCK.ShowInfoDialog('To edit this section please switch to WikiText view by clicking the "Source" button');}}else if (C.getAttribute('contentEditable')=='false') {while (!C.getAttribute('refid')) {C=C.parentNode;};var H=C.getAttribute('refid');FCK.NodesWithRefId[H]=C;if (FCK.wysiwygData[H].type=='image') {FCK.ProtectImageEdit(H);}}});FCK.SetupElementsWithRefId();}else {FCK.TemplatePreviewInit();FCKTools.AddEventListener(FCK.EditingArea.Textarea,'keydown',function(e) {e=FCK.YE.getEvent(e);if (e.keyCode==9) {FCK.log('tab key pressed');FCK.YE.stopEvent(e);var K=window.parent.document.getElementById('wpSummary')||window.parent.document.getElementById('wpSummaryEnhanced');if (K) {K.focus();}}});FCK.WysiwygSwitchToolbars(1);};FCK.GetParentForm().className=(FCK.EditMode==0?'wysiwyg':'source')+'_mode';FCK.onWysiwygLoad();});FCK.SetupElementsWithRefId=function() {FCK.TemplatePreviewInit();var A=FCK.GetNodesWithRefId();FCK.log(A);for (n=A.length-1;n>=0;n--) {var B=A[n];var C=B.getAttribute('refid');if (!C) {continue;};var D=FCK.wysiwygData[C];if (!D) {continue;};B.setAttribute('_fck_editor_instance',FCK.EditorInstanceId);var E=B.getAttribute('_fck_type')||D.type;var F=B.nodeName.toLowerCase();switch(E) {case 'template':FCK.TemplatePreviewAdd(B);break;case 'image':FCK.ProtectImage(B);break;case 'video':FCK.ProtectVideo(B);break;case 'video_add':FCK.ProtectVideoAdd(B);break;case 'internal link':B.title=D.href;break;case 'external link':B.title=D.href;break;case 'hook':if ((typeof FCK.VideoSetupGalleryPlaceholder!='undefined')&&(D.name=='videogallery')) {FCK.VideoSetupGalleryPlaceholder(B);}};if (F=='input') {FCK.FixWikitextPlaceholder(B);}};FCK.log('setup of nodes with refid finished');return true;};FCK.ShowInfoDialog=function(A,B) {FCK.jQuery.getScript(window.parent.stylepath+'/common/jquery/jquery.wikia.modal.js?'+FCKConfig.StyleVersion,function() {if (!B) {B='&nbsp;';};var C='<div id="wysiwygInfobox" title="'+B+'"><div style="padding: 5px">'+A+'</div></div>';FCK.jQuery("#positioned_elements").append(C);FCK.jQuery("#wysiwygInfobox").makeModal({width:450});});};FCK.ShowConfirm=function(A,B,C) {FCK.jQuery.getScript(window.parent.stylepath+'/common/jquery/jquery.wikia.modal.js?'+FCKConfig.StyleVersion,function() {if (!B) {B='&nbsp;';};var D='<div id="wysiwygConfirm" title="'+B+'"><div style="padding: 5px">'+A+'<div style="border-top: solid 1px #ddd; text-align: right; padding-top: 5px; margin-top: 5px"><button id="wysiwygConfirmOk" style="margin: 0 8px">'+FCKLang.DlgBtnOK+'</button><button id="wysiwygConfirmCancel">'+FCKLang.DlgBtnCancel+'</button></div></div></div>';FCK.jQuery("#positioned_elements").append(D);var E=function() {FCK.jQuery('#wysiwygConfirm').closest('.modalWrapper').find('h1 div').click()};FCK.jQuery('#wysiwygConfirmOk').click(function() {E();if (typeof C=='function') {C();}});FCK.jQuery('#wysiwygConfirmCancel').click(E);FCK.jQuery("#wysiwygConfirm").makeModal({width:450});});};FCK.FixWikitextPlaceholder=function(A) {A.setAttribute('_fckContextMenuDisabled',true);if (A.parentNode.nodeName.IEquals(['p','div','li','dt','dd'])&&(A==A.parentNode.lastChild||(A.parentNode.lastChild.previousSibling&&A==A.parentNode.lastChild.previousSibling.previousSibling))) {if (FCKBrowserInfo.IsGecko10) {var B=FCK.EditorDocument.createDocumentFragment();B.appendChild(FCK.EditorDocument.createTextNode('\xA0'));A.parentNode.appendChild(B);}else {FCK.InsertDirtySpanAfter(A);}};if ((A.nextSibling&&A.nextSibling.nodeName.IEquals('input'))) {FCK.InsertDirtySpanAfter(A);};if (A.parentNode.firstChild==A) {FCK.InsertDirtySpanBefore(A);};if (A.parentNode.nodeName.IEquals('body')) {FCK.InsertDirtySpanBefore(A);FCK.InsertDirtySpanAfter(A);}};FCK.ParseWikitext=function(A,B,C,D) {var B={success:function(o) {html=o.responseText;FCK=o.argument.FCK;C=o.argument.data;B=o.argument.callback;B(html,FCK,C);},failure:function(o) {},argument:{'FCK':FCK,'data':C,'callback':B}};var E=[];E.push('action=ajax');E.push('title='+encodeURIComponent(window.parent.wgPageName));E.push('rs=WysiwygParseWikitext');E.push('rsargs[]='+encodeURIComponent(A));if (D) {E.push('wysiwyg=1');};FCK.YAHOO.util.Connect.asyncRequest('POST',((window.parent.wgScript==null)?(window.parent.wgScriptPath+"/index.php"):window.parent.wgScript),B,E.join('&'));};FCK.CheckInternalLink=function(A,B) {var C={success:function(o) {FCK=o.argument.FCK;A=o.argument.title;B=o.argument.link;result=eval('('+o.responseText+')');pageExists=(typeof result.query.pages[-1]=='undefined');FCK.log('"'+A+'" '+(pageExists?'exists':'doesn\'t exist'));if (B) {if (pageExists) {FCK.YD.removeClass(B,'new');B.href=window.parent.wgServer+window.parent.wgArticlePath.replace(/\$1/,encodeURI(A.replace(/ /g,'_')));} else {FCK.YD.addClass(B,'new');B.href=window.parent.wgServer+window.parent.wgScript+'?title='+encodeURIComponent(A.replace(/ /g,'_'))+'&action=edit&redlink=1';};FCK.log('href: '+B.href);}},failure:function(o) {},argument:{'FCK':FCK,'link':B,'title':A}};FCK.YAHOO.util.Connect.asyncRequest("POST",window.parent.wgScriptPath+'/api.php',C,"action=query&format=json&prop=info&titles="+encodeURIComponent(A));};FCK.ProtectImageOverlay=false;FCK.ProtectImage=function(A) {var B=parseInt(A.getAttribute('refid'));if (FCK.UseContentEditable) {A.setAttribute('contentEditable',false);FCK.YD.getElementsBy(function(J) {return true;},false,A,function(K) {K.setAttribute('contentEditable',false);});FCKTools.RemoveEventListener(A,'click',FCK.ImageProtectOnClick);FCKTools.AddEventListener(A,'click',FCK.ImageProtectOnClick);FCKTools.RemoveEventListener(A,'mousedown',FCK.ImageProtectOnMousedown);FCKTools.AddEventListener(A,'mousedown',FCK.ImageProtectOnMousedown);FCKTools.RemoveEventListener(A,'mouseup',FCK.ImageProtectOnMouseup);FCKTools.AddEventListener(A,'mouseup',FCK.ImageProtectOnMouseup);FCK.BlockEvent(A,'contextmenu');FCK.wysiwygData[B].exists=A.nodeName.IEquals('a')?(!FCK.YD.hasClass(A,'new')):!(/class=\"new\"/.test(A.innerHTML));FCK.NodesWithRefId[B]=A;FCK.ImageProtectSetupOverlayMenu(B,A);return;};var C=FCK.EditingArea.Document.createElement('iframe');var D=FCK.EditingArea.Document.createElement('div');C.src=window.parent.wgServer+window.parent.wgScript+'?action=ajax&rs=WysiwygImage&title='+encodeURIComponent(window.parent.wgPageName)+'&wikitext='+encodeURIComponent(FCK.wysiwygData[B].original);C.name='image'+B;C.setAttribute('refid',B);C.className=A.className;if (A.nodeName.IEquals('a')) {var E={width:A.firstChild.width,height:A.firstChild.height+6};}else if (A.nodeName.IEquals('iframe')) {var E={width:A.style.width,height:parseInt(A.style.height)+6};}else {var E={width:A.firstChild.style.width,height:A.clientHeight+6};};FCK.log(A);FCK.log(E);C.style.width=parseInt(E.width)+20+'px';C.style.height=parseInt(E.height)+6+'px';C.style.border='none';C.style.overflow='hidden';A.parentNode.insertBefore(C,A);A.parentNode.removeChild(A);FCK.NodesWithRefId[B]=C;var H=FCKTools.GetElementDocument(FCK.EditingArea.TargetElement);D=H.getElementById('cover'+B);if (!D) {D=H.createElement('DIV');D.id='cover'+B;D.setAttribute('refid',B);H.body.appendChild(D);};D.className='cover '+A.className;D.style.width=C.style.width;D.style.height=C.style.height;D.style.position='absolute';D.style.cursor='pointer';D.innerHTML='&nbsp;';FCK.ProtectImageRepositionCover(B);var I=/class=\"new\"/;FCK.wysiwygData[B].exists=!I.test(A.innerHTML);FCK.ImageProtectSetupOverlayMenu(B,D);};FCK.GetParentImage=function(A) {var B=A;while (B&&B.getAttribute&&!FCK.YAHOO.lang.isNumber(parseInt(B.getAttribute('refid')))) {B=B.parentNode;};if (B&&B.getAttribute&&FCK.YAHOO.lang.isNumber(parseInt(B.getAttribute('refid')))) {return B;}else {return false;}};FCK.ImageProtectOnClick=function(e) {var e=FCK.YE.getEvent(e);var A=FCK.YE.getTarget(e);FCK.YE.stopEvent(e);if (e.button==0) {var B=FCK.GetParentImage(A);var C=parseInt(B.getAttribute('refid'));FCK.log('image #'+C+' clicked');switch (A.className) {case 'imageOverlayRemove':FCK.ProtectImageRemove(C);break;case 'imageOverlayEdit':FCK.ProtectImageEdit(C);break;}}};FCK.ImageProtectOnMousedown=function(e) {var e=FCK.YE.getEvent(e);var A=FCK.YE.getTarget(e);if (A.className=='imageOverlayDrag') {var B=FCK.GetParentImage(A);var C=parseInt(B.getAttribute('refid'));FCK.log('image #'+C+' drag&drop catched');FCK.Track('/image/move');FCK.Selection.SelectNode(B);FCK.ImageDragDrop=B;}else {FCK.YE.stopEvent(e);}};FCK.ImageProtectOnMouseup=function(e) {FCK.YE.stopEvent(FCK.YE.getEvent(e));var A=FCKSelection.GetSelection();if (A.removeAllRanges) {A.removeAllRanges();}};FCK.ImageProtectSetupOverlayMenu=function(A,B) {if (B.lastChild&&B.lastChild.nodeName.IEquals('span')&&FCK.YD.hasClass(B.lastChild,'imageOverlay')) {FCKDomTools.RemoveNode(B.lastChild);};B.setAttribute('refid',A);var C=FCKTools.GetElementDocument(B);var D=C.createElement('SPAN');D.className='imageOverlay'+(FCK.YD.hasClass(B,'thumb')?' imageOverlayRight':'');D.style.visibility='hidden';B.style.position='relative';if (B.nodeName.IEquals('a')&&!FCKBrowserInfo.IsIE) {var E=parseInt(B.firstChild.offsetHeight/2);D.style.top=(-E+8)+'px';};B.appendChild(D);D.innerHTML='<span class="imageOverlayEdit" onclick="FCK.ProtectImageEdit('+A+')">'+FCKLang.DlgSelectBtnModify+'</span><span class="imageOverlayRemove" onclick="FCK.ProtectImageRemove('+A+')">'+FCKLang.DlgSelectBtnDelete+'</span>';if (FCK.UseContentEditable) {D.innerHTML+='<span class="imageOverlayDrag">move</span>';};FCKTools.AddEventListener(B,'mouseover',function(e) {D.style.visibility='visible';});FCKTools.AddEventListener(B,'mouseout',function(e) {D.style.visibility='hidden';});};FCK.ProtectImageRepositionCover=function(A) {if (FCK.EditMode==1) {return;};var B=FCK.GetElementByRefId(A);var C=FCKTools.GetElementDocument(FCK.EditingArea.TargetElement).getElementById('cover'+A);if (!B) {FCKDomTools.RemoveNode(C);return;};var D=FCK.YD.getXY(B);var E=FCK.EditorDocument.body.scrollTop;FCK.YD.setXY(C,[D[0],D[1]-E+30]);C.style.width=B.style.width;C.style.height=B.style.height;setTimeout('FCK.ProtectImageRepositionCover('+A+')',750);};FCK.ProtectImageEdit=function(A) {FCK.log('click on image #'+A);FCK.log(FCK.wysiwygData[A]);FCK.Track('/image/click');window.parent.WMU_show(parseInt(A));};FCK.ProtectImageRemove=function(A,B) {var C=function() {FCKUndo.SaveUndoStep();FCK.log('removed image #'+A);var D=FCK.GetElementByRefId(A);FCKDomTools.RemoveNode(D);delete FCK.wysiwygData[A];delete FCK.NodesWithRefId[A];FCK.Track('/image/remove');};if (B) {C();} else {FCK.ShowConfirm('Are you sure you want to remove this image?','Remove this image',C);}};FCK.ProtectImageUpdate=function(A,B,C) {FCK.log('updating #'+A+' with >>'+B+'<<');FCK.Track('/image/update');FCKUndo.SaveUndoStep();var D=B.substring(2,B.length-2).split('|');FCK.wysiwygData[A].href=D.shift();FCK.wysiwygData[A].description=D.join('|');FCK.wysiwygData[A].original=B;FCK.wysiwygData[A]=FCK.YAHOO.lang.merge(FCK.wysiwygData[A],C);FCK.log(FCK.wysiwygData[A]);var E={success:function(o) {FCK=o.argument.FCK;A=o.argument.refid;var F=FCK.GetElementByRefId(A);FCK.log(F);result=eval('('+o.responseText+')');html=result.parse.text['*'];html=FCK.YAHOO.lang.trim(html.split('<!-- \nNewPP limit report')[0]);var G=FCKTools.GetElementDocument(F).createElement('DIV');if (F.nodeName.IEquals('a')&&FCKBrowserInfo.IsIE) {F.parentNode.parentNode.insertBefore(G,F.parentNode);}else {F.parentNode.insertBefore(G,F);};G.innerHTML=html;if (html.substr(0,3)=='<p>') {G.innerHTML=html.substr(3,html.length-7);};G.firstChild.setAttribute('refid',A);FCK.ProtectImage(G.firstChild);if (F.getAttribute('_wysiwyg_new_line')) {G.firstChild.setAttribute('_wysiwyg_new_line',true);};if (F.getAttribute('_wysiwyg_line_start')) {G.firstChild.setAttribute('_wysiwyg_line_start',true);};FCKDomTools.RemoveNode(F,false);FCKDomTools.RemoveNode(G,true);},failure:function(o) {},argument:{'FCK':FCK,'refid':A}};FCK.YAHOO.util.Connect.asyncRequest('POST',window.parent.wgScriptPath+'/api.php',E,"action=parse&format=json&prop=text&title="+encodeURIComponent(window.parent.wgPageName)+"&text="+encodeURIComponent(B));};FCK.ProtectImageAdd=function(A,B) {var C=FCK.GetFreeRefId();FCK.log('adding new image #'+C+' using >>'+A+'<<');FCK.Track('/image/add');var D=A.substring(2,A.length-2).split('|');FCK.wysiwygData[C]={'type':'image','href':D.shift(),'description':D.join('|'),'original':A,'exists':true};FCK.wysiwygData[C]=FCK.YAHOO.lang.merge(FCK.wysiwygData[C],B);var E={success:function(o) {FCK=o.argument.FCK;C=o.argument.refid;result=eval('('+o.responseText+')');html=result.parse.text['*'];html=FCK.YAHOO.lang.trim(html.split('<!-- \nNewPP limit report')[0]);var F=FCK.EditorDocument.createElement('DIV');FCK.InsertElement(F);F.innerHTML=html;if (html.substr(0,3)=='<p>') {F.innerHTML=html.substr(3,html.length-7);};F.firstChild.setAttribute('refid',C);FCK.ProtectImage(F.firstChild);FCKDomTools.RemoveNode(F,true);FCK.log(FCK.wysiwygData[C]);},failure:function(o) {},argument:{'FCK':FCK,'refid':C}};FCK.YAHOO.util.Connect.asyncRequest('POST',window.parent.wgScriptPath+'/api.php',E,"action=parse&format=json&prop=text&title="+encodeURIComponent(window.parent.wgPageName)+"&text="+encodeURIComponent(A));};FCK.TemplatePreviewCloud=false;FCK.TemplatePreviewTimeouts={Tag:false,Cloud:false};FCK.TemplatePreviewInit=function() {if (FCK.TemplatePreviewCloud) {FCK.TemplatePreviewCloud.parentNode.removeChild(FCK.TemplatePreviewCloud);FCK.TemplatePreviewCloud=false;FCK.TemplatePreviewTimeouts={Tag:false,Cloud:false};}};FCK.TemplatePreviewAdd=function(A) {var B=FCKTools.GetElementDocument(FCK.EditingArea.TargetElement);if (!FCK.TemplatePreviewCloud) {FCK.TemplatePreviewCloud=B.createElement('DIV');B.body.appendChild(FCK.TemplatePreviewCloud);FCK.TemplatePreviewCloud.id='wysiwygTemplatePreviewCloud';FCK.TemplatePreviewCloud.innerHTML='<div id="wysiwygTemplatePreviewCloudInner"></div>';FCKTools.AddEventListener(FCK.TemplatePreviewCloud,'mouseover',function(e) {clearTimeout(FCK.TemplatePreviewTimeouts.Tag);clearTimeout(FCK.TemplatePreviewTimeouts.Cloud);});FCKTools.AddEventListener(FCK.TemplatePreviewCloud,'mouseout',function(e) {FCK.TemplatePreviewTimeouts.Cloud=setTimeout('FCK.TemplatePreviewHide()',1000);});};var C=A.getAttribute('refid');var D=B.getElementById('wysiwygTemplatePreview'+C);if (D) {FCKDomTools.RemoveNode(D);};var E=A.nextSibling;D=B.createElement('div');FCK.TemplatePreviewCloud.firstChild.appendChild(D);D.id='wysiwygTemplatePreview'+C;A.title='Click to edit this template or use drag&drop to move template';D.innerHTML=(FCK.wysiwygData[C].preview?FCK.wysiwygData[C].preview:E.value);D.setAttribute('refid',C);D.innerHTML=D.innerHTML.Trim();D.style.display='none';FCK.TemplatePreviewReset(D);if (E&&E.nodeName.IEquals('input')&&E.type=='text') {E.parentNode.removeChild(E);FCK.wysiwygData[C].preview=D.innerHTML;};FCKTools.RemoveEventListener(A,'mouseover',FCK.TemplatePreviewOnPlaceholderMouseover);FCKTools.RemoveEventListener(A,'mouseout',FCK.TemplatePreviewOnPlaceholderMouseout);FCKTools.RemoveEventListener(A,'click',FCK.TemplatePreviewOnPlaceholderClick);FCKTools.RemoveEventListener(D,'click',FCK.TemplatePreviewOnPreviewClick);FCKTools.AddEventListener(A,'mouseover',FCK.TemplatePreviewOnPlaceholderMouseover);FCKTools.AddEventListener(A,'mouseout',FCK.TemplatePreviewOnPlaceholderMouseout);FCKTools.AddEventListener(A,'click',FCK.TemplatePreviewOnPlaceholderClick);FCKTools.AddEventListener(D,'click',FCK.TemplatePreviewOnPreviewClick);};FCK.TemplatePreviewOnPlaceholderMouseover=function(e) {FCK.TemplatePreviewShow(FCK.YE.getTarget(e));clearTimeout(FCK.TemplatePreviewTimeouts.Tag);clearTimeout(FCK.TemplatePreviewTimeouts.Cloud);};FCK.TemplatePreviewOnPlaceholderMouseout=function(e) {FCK.TemplatePreviewTimeouts.Tag=setTimeout('FCK.TemplatePreviewHide()',500);};FCK.TemplatePreviewOnPlaceholderClick=function(e) {var e=FCK.YE.getEvent(e);var A=FCK.YE.getTarget(e);var B=A.getAttribute('refid');FCK.TemplateWizard={'name':FCK.wysiwygData[B].name,'params':FCK.wysiwygData[B].templateParams,'refid':B};FCK.TemplateClickCommand.Execute();};FCK.TemplatePreviewOnPreviewClick=function(e) {FCK.YE.stopEvent(FCK.YE.getEvent(e));var A=FCK.TemplatePreviewCloud.getAttribute('refid');FCK.TemplateWizard={'name':FCK.wysiwygData[A].name,'params':FCK.wysiwygData[A].templateParams,'refid':A};FCK.TemplateClickCommand.Execute();};FCK.TemplatePreviewShow=function(A) {var B=A.getAttribute('refid');var C=FCKTools.GetElementDocument(FCK.TemplatePreviewCloud).getElementById('wysiwygTemplatePreview'+B);var D=FCK.TemplatePreviewCloud.firstChild.childNodes;for (p=0;p<D.length;p++) {D[p].style.display='none';};C.style.display='';var E=FCK.ToolbarSet._TargetElement.offsetHeight;var x=FCK.YD.getX(A);var y=FCK.YD.getY(A)+A.clientHeight+E+5;var F=[FCK.EditorDocument.body.scrollLeft,FCK.EditorDocument.body.scrollTop];var G={x:parseInt(x-F[0]),y:parseInt(y-F[1])};var H=FCK.EditingArea.IFrame.offsetHeight;var I=C.offsetHeight<250?C.offsetHeight:250;var J=true;FCK.TemplatePreviewCloud.firstChild.style.height='auto';if (G.y+I>H) {if (G.y<280) {I=G.y-80;FCK.TemplatePreviewCloud.firstChild.style.height=I+'px';};G.y-=parseInt(A.clientHeight+25+I);J=false;};FCK.TemplatePreviewCloud.style.left=G.x+'px';FCK.TemplatePreviewCloud.style.top=G.y+'px';FCK.TemplatePreviewCloud.style.display='block';FCK.TemplatePreviewCloud.className=J?'cloudUnder':'cloudOver';FCK.TemplatePreviewCloud.setAttribute('refid',B);};FCK.TemplatePreviewHide=function() {FCK.TemplatePreviewCloud.style.display='none';};FCK.TemplatePreviewSetHTML=function(A,B) {var C=FCKTools.GetElementDocument(FCK.TemplatePreviewCloud).getElementById('wysiwygTemplatePreview'+A);C.innerHTML=B;FCK.wysiwygData[A].preview=B;FCK.TemplatePreviewReset(C);FCK.log('saved template preview for #'+A);};FCK.TemplatePreviewGetHTML=function(A) {return FCK.wysiwygData[A].preview;};FCK.TemplatePreviewSetName=function(A,B) {var C=FCK.GetElementByRefId(A);C.value=FCK.YAHOO.lang.trim(B);};FCK.TemplatePreviewReset=function(A) {if (A.firstChild&&A.firstChild.nodeType==1) {FCK.YD.addClass(A.firstChild,'resetTemplate');A.firstChild.removeAttribute('align');}};var FCKInsertTemplateCommand=function() {this.Name='InsertTemplate';};FCKInsertTemplateCommand.prototype={Execute:function(A) {oInsertTemplateItem._Combo.SetLabel(oInsertTemplateItem.DefaultLabel);if(A==':other:') {FCK.TemplateWizard={};FCK.TemplateClickCommand.Execute();} else {FCK.Track('/templateEditor/dropdown/'+A);if(FCK.templateList[A].params) {FCK.TemplateWizard={'name':A,'params':FCK.templateList[A].params,'refid':-1};FCK.TemplateClickCommand.Execute();} else {FCK.InsertTemplate(-1,A,null);}}},GetState:function() {if(FCK.EditMode!=0) return -1;return 0;}};FCK.GenerateTemplateWikitext=function(A,B) {var C='';C='{{'+A;var D=0;var E=0;for (key in B) {if ((B[key]!='')&&(E<key.length)) {E=key.length;}};for(key in B) {var F=FCK.YAHOO.Tools.trim(B[key]);if (F=='') continue;var G=FCK.YAHOO.Tools.stringRepeat(' ',E-key.length);C+='\n|'+key+G+' = '+F;D++;};C+=(D?'\n}}':'}}');FCK.log('template wikisyntax >>'+C+'<< (longest param: '+E+')');return C;};FCK.InsertTemplate=function(A,B,C) {FCK.log([A,B,C]);var D;if (A>-1) {FCK.log('updating template #'+A);var D=FCK.GetElementByRefId(A);}else {A=FCK.GetFreeRefId();FCK.log('inserting new template as #'+A);D=FCK.EditorDocument.createElement('INPUT');D.className='wysiwygDisabled wysiwygTemplate';D.type='button';D.value=B;D.setAttribute('refid',A);D.setAttribute('_fck_type','template');FCK.InsertElement(D);FCK.wysiwygData[A]={'type':'template'};FCK.NodesWithRefId[A]=D;FCK.FixWikitextPlaceholder(D);};D.value=B;var F=FCK.GenerateTemplateWikitext(B,C);FCK.wysiwygData[A].name=B;FCK.wysiwygData[A].originalCall=F;FCK.wysiwygData[A].templateParams=C;FCK.wysiwygData[A].preview='<p><em>please wait</em></p>';FCK.log(FCK.wysiwygData[A]);FCK.TemplatePreviewAdd(D);FCK.ParseWikitext(F,function(G,H,I) {A=I.refid;H.wysiwygData[A].preview=G;H.TemplatePreviewAdd(H.GetElementByRefId(A));H.log('template #'+A+' preview updated');},{'refid':A});};FCKCommands.RegisterCommand('InsertTemplate',new FCKInsertTemplateCommand());var FCKToolbarInsertTemplateCombo=function(A,B) {this.CommandName='InsertTemplate';this.Label=this.GetLabel();this.Tooltip=A?A:this.Label;this.Style=B?B:2;this.DefaultLabel='Insert template';this.FieldWidth=120;};FCKToolbarInsertTemplateCombo.prototype=new FCKToolbarSpecialCombo;FCKToolbarInsertTemplateCombo.prototype.GetLabel=function() {return '';};FCKToolbarInsertTemplateCombo.prototype.CreateItems=function(A) {FCK.templateList=window.parent.templateList;for(key in FCK.templateList) {A.AddItem(key,(FCK.templateList[key].desc)?FCK.templateList[key].desc:FCK.templateList[key].name);};A.AddItem(":other:","Other template / magic word",'',true);};var oInsertTemplateItem=new FCKToolbarInsertTemplateCombo();FCKToolbarItems.RegisterItem('InsertTemplate',oInsertTemplateItem);FCK.Events.AttachEvent("OnUndoRedo",function() {FCK.log('undo/redo catched');FCK.SetupElementsWithRefId();});FCK.YAHOO=window.parent.YAHOO;FCK.YD=FCK.YAHOO.util.Dom;FCK.YE=FCK.YAHOO.util.Event;FCK.jQuery=window.parent.jQuery;FCK.log=function(A) {window.parent.$().log(A,'Wysiwyg');};FCK.Track=function(A) {window.parent.WET.byStr('wysiwyg'+A);};FCK.Diff=function(o,n) {if (o==n) {return null;};var A=o.length-n.length;var B={start:0,end:n.length-1};while (o.charAt(B.start)==n.charAt(B.start)) {if (B.start>=o.length) {return null;};B.start++;}while (o.charAt(B.end+A)==n.charAt(B.end)) {if (B.end<=B.start) {return null;};B.end--;};var C=n.substring(0,B.start+1);var D=n.substring(B.end,n.length);if (/<[^>]*$/.test(C)) {B.start=C.lastIndexOf('<');};if (/^[^<]*>/.test(D)) {B.end+=D.indexOf('>')+1;};var E=n.substring(B.start,B.end);return {html:E,index:B.start,'new':n,'old':o};};FCK._CheckPasteOldHTML=false;FCK._CheckPasteChecks=0;FCK.CheckPaste=function() {FCK.log('CheckPaste');if (FCK._CheckPasteOldHTML!=false) {FCK.log('CheckPaste in progress');return false;};FCK._CheckPasteOldHTML=FCK.EditorDocument.body.innerHTML;FCK._CheckPasteChecks=0;setTimeout(FCK.CheckPasteCompare,10);return true;};FCK.CheckPasteCompare=function() {FCK.log('CheckPasteCompare');FCK._CheckPasteChecks++;var A=FCK.EditorDocument.body.innerHTML;var B=FCK._CheckPasteOldHTML;if (A==B) {if (FCK._CheckPasteChecks>50) {FCK.log('CheckPasteCompare timed out');FCK._CheckPasteOldHTML=false;}else {setTimeout(FCK.CheckPasteCompare,10);};return;};var C=FCK.Diff(B,A);FCK.log(C);if (C!=null) {var D=C.html.match(/_fck_editor_instance="(\d+)"[^>]*>/);if (D!=null&&(parseInt(D[1])!=FCK.EditorInstanceId)) {FCK.log('Pasted from different editor instance!');FCK.Track('/paste/outside');FCK.ShowInfoDialog('To copy from another article you must first click the "wikitext source mode" button on the toolbar of both the original and new pages');FCK.EditorDocument.body.innerHTML=B;FCK.SetupElementsWithRefId();FCK._CheckPasteOldHTML=false;return;};var E=/refid="(\d+)"[^>]*>/g;var F=[];while (match=E.exec(C.html)) {F.push(match);};if (F.length>0) {var G=A.substr(0,C.index);var A=A.substring(C.index,A.length);for(n=0;n<F.length;n++) {var I=parseInt(F[n][1]);FCK.log('Checking refid #'+I);var J=FCK.GetFreeRefId();FCK.wysiwygData[J]=window.parent.$().extend(true,{},FCK.wysiwygData[I]);FCK.log('New refid #'+J);var E=new RegExp('refid="'+I+'"([^>]*>)');A=A.replace(E,'refid="'+J+'"$1');};FCK.Track('/paste/inside');FCK.EditorDocument.body.innerHTML=G+A;FCK.SetupElementsWithRefId();}else {FCK.Track('/paste/plainText');}};FCK._CheckPasteOldHTML=false;};FCK.EnableAutocomplete=function(A,B,C) {FCK.jQuery.getScript(window.parent.stylepath+'/common/jquery/jquery.autocomplete.js?'+FCKConfig.StyleVersion,function() {var D=window.parent.wgServer+window.parent.wgScript+'?action=ajax&rs=getLinkSuggest&format=json';if (C) {D+='&ns=10';};FCK.jQuery(A).autocomplete({serviceUrl:D,fnFormatResult:function(v) {return v;},onSelect:function(v,d) {if (typeof B=='function') {B();}},deferRequestBy:110,delimiter:"\n",maxHeight:110,appendTo:FCK.jQuery(A).parent().parent()});});};FCK.Track('/init');if (!FCKBrowserInfo.IsIE) {FCKTools.AddEventListener(window,'beforeunload',function() {var A=window.parent.document.getElementById('wysiwygTemporarySaveType');var B=window.parent.document.getElementById('wysiwygTemporarySaveContent');var C=window.parent.document.getElementById('wysiwygData');A.value=FCK.EditMode;B.value=(FCK.EditMode==1)?FCK.GetData():FCK.EditorDocument.body.innerHTML;C.value=FCK.YAHOO.Tools.encodeArr(FCK.wysiwygData);FCK.log('editor state saved');FCK.Track('/temporarySave/store');});}else {FCK.log('temporary save not supported in your browser');};FCK.UseContentEditable=FCKBrowserInfo.IsIE||FCKBrowserInfo.IsGecko19;if (FCK.UseContentEditable) {FCK.log('using contentEditable');};FCK.BrowserInfo=FCKBrowserInfo;window.parent.FCK=FCK;
var FCKAddVideoCommand=function() {this.Name='AddVideo';this.IsEnabled=(typeof window.parent.vet_enabled!='undefined');};FCKAddVideoCommand.prototype={Execute:function() {FCKUndo.SaveUndoStep();FCK.log('opening "add video" dialog');window.parent.VET_show(-1);},GetState:function() {if ((FCK.EditMode!=0)||(this.IsEnabled==false)) return -1;return 0;}};FCKCommands.RegisterCommand('AddVideo',new FCKAddVideoCommand());var oTildesItem=new FCKToolbarButton('AddVideo','Add video');oTildesItem.IconPath=FCKConfig.PluginsPath+'video/addVideo.png';FCKToolbarItems.RegisterItem('AddVideo',oTildesItem);FCK.VideoOverlay=false;FCK.ProtectVideo=function(A) {var B=parseInt(A.getAttribute('refid'));if (FCK.UseContentEditable) {A.setAttribute('contentEditable',false);FCK.YD.getElementsBy(function(C) {return true;},false,A,function(D) {D.setAttribute('contentEditable',false);});FCKTools.RemoveEventListener(A,'click',FCK.VideoOnClick);FCKTools.AddEventListener(A,'click',FCK.VideoOnClick);FCKTools.RemoveEventListener(A,'mousedown',FCK.VideoOnMousedown);FCKTools.AddEventListener(A,'mousedown',FCK.VideoOnMousedown);FCKTools.RemoveEventListener(A,'mouseup',FCK.VideoOnMouseup);FCKTools.AddEventListener(A,'mouseup',FCK.VideoOnMouseup);FCK.BlockEvent(A,'contextmenu');FCK.NodesWithRefId[B]=A;FCK.VideoSetupOverlayMenu(B,A);return;}};FCK.ProtectVideoAdd=function(A) {var B=parseInt(A.getAttribute('refid'));if (FCK.UseContentEditable) {A.setAttribute('contentEditable',false);FCK.YD.getElementsBy(function(D) {return true;},false,A,function(E) {E.setAttribute('contentEditable',false);});var C=A.getElementsByTagName('a')[0];FCKTools.RemoveEventListener(C,'click',FCK.VideoOnClick);FCKTools.AddEventListener(C,'click',FCK.VideoAddOnClick);FCK.BlockEvent(A,'contextmenu');FCK.BlockEvent(A,'mousedown');FCK.BlockEvent(A,'mouseup');FCK.NodesWithRefId[B]=A;return;}};FCK.VideoOnClick=function(e) {var e=FCK.YE.getEvent(e);var A=FCK.YE.getTarget(e);FCK.YE.stopEvent(e);if (e.button==0) {var B=FCK.GetParentImage(A);var C=parseInt(B.getAttribute('refid'));FCK.log('video #'+C+' clicked');switch (A.className) {case 'videoOverlayRemove':FCK.VideoRemove(C);break;case 'videoOverlayEdit':FCK.VideoEdit(C);break;}}};FCK.VideoAddOnClick=function(e) {var e=FCK.YE.getEvent(e);var A=FCK.YE.getTarget(e);FCK.YE.stopEvent(e);if (e.button==0) {var B=FCK.GetParentImage(A);var C=parseInt(B.getAttribute('refid'));FCK.log('video add #'+C+' clicked');FCK.log(FCK.wysiwygData[C]);FCK.Track('/video/add');window.parent.VET_show(parseInt(C),-1);}};FCK.VideoOnMousedown=function(e) {var e=FCK.YE.getEvent(e);var A=FCK.YE.getTarget(e);if (A.className=='videoOverlayDrag') {var B=FCK.GetParentImage(A);var C=parseInt(B.getAttribute('refid'));FCK.log('video #'+C+' drag&drop catched');FCK.Track('/video/move');FCK.Selection.SelectNode(B);FCK.VideoDragDrop=B;}else {FCK.YE.stopEvent(e);}};FCK.VideoOnMouseup=function(e) {FCK.YE.stopEvent(FCK.YE.getEvent(e));var A=FCKSelection.GetSelection();if (A.removeAllRanges) {A.removeAllRanges();}};FCK.VideoEdit=function(A) {FCK.log('click on video #'+A);FCK.log(FCK.wysiwygData[A]);FCK.Track('/video/click');window.parent.VET_show(parseInt(A));};FCK.VideoRemove=function(A,B) {var C=function() {FCKUndo.SaveUndoStep();FCK.log('removed video #'+A);var D=FCK.GetElementByRefId(A);FCKDomTools.RemoveNode(D);delete FCK.wysiwygData[A];delete FCK.NodesWithRefId[A];FCK.Track('/video/remove');};if (B) {C();} else {FCK.ShowConfirm('Are you sure you want to remove this video?','Remove this video',C);}};FCK.VideoUpdate=function(A,B,C) {FCK.log('updating #'+A+' with >>'+B+'<<');FCK.Track('/video/update');FCKUndo.SaveUndoStep();FCK.wysiwygData[A]={type:"video",original:B};FCK.wysiwygData[A]=FCK.YAHOO.lang.merge(FCK.wysiwygData[A],C);FCK.log(FCK.wysiwygData[A]);FCK.ParseWikitext(B,function(F,G,H) {A=H.refid;var D=G.GetElementByRefId(A);G.log(D);var E=FCKTools.GetElementDocument(D).createElement('DIV');if (D.nodeName.IEquals('a')&&FCKBrowserInfo.IsIE) {D.parentNode.parentNode.insertBefore(E,D.parentNode);}else {D.parentNode.insertBefore(E,D);};E.innerHTML=F;E.firstChild.setAttribute('refid',A);G.ProtectVideo(E.firstChild);if (D.getAttribute('_wysiwyg_new_line')) {E.firstChild.setAttribute('_wysiwyg_new_line',true);};if (D.getAttribute('_wysiwyg_line_start')) {E.firstChild.setAttribute('_wysiwyg_line_start',true);}else {E.firstChild.removeAttribute('_wysiwyg_line_start');};FCKDomTools.RemoveNode(D,false);FCKDomTools.RemoveNode(E,true);},{'refid':A},true);};FCK.VideoAdd=function(A,B,C) {var D=FCK.GetFreeRefId();FCK.log('adding new video #'+D+' using >>'+A+'<<');if (C!=null) {FCK.log('replacing "Add video" placeholder #'+C);};FCK.Track('/video/add');var E=A.substring(2,A.length-2).split('|');FCK.wysiwygData[D]={type:'video',original:A,href:E[0]};FCK.wysiwygData[D]=FCK.YAHOO.lang.merge(FCK.wysiwygData[D],B);FCK.ParseWikitext(A,function(H,I,J) {D=J.refid;var F=I.EditorDocument.createElement('DIV');if (C!=null) {var G=I.GetElementByRefId(C);G.parentNode.replaceChild(F,G);}else {I.InsertElement(F);};F.innerHTML=H;if (H.substr(0,3)=='<p>') {F.innerHTML=H.substr(3,H.length-7);};F.firstChild.setAttribute('refid',D);I.ProtectVideo(F.firstChild);FCKDomTools.RemoveNode(F,true);I.log(I.wysiwygData[D]);},{'refid':D,'placeholderRefId':C},true);};FCK.VideoSetupOverlayMenu=function(A,B) {if (B.lastChild&&B.lastChild.nodeName.IEquals('span')&&FCK.YD.hasClass(B.lastChild,'videoOverlay')) {FCKDomTools.RemoveNode(B.lastChild);};B.setAttribute('refid',A);var C=FCKTools.GetElementDocument(B);var D=C.createElement('SPAN');D.className='imageOverlay'+(FCK.YD.hasClass(B,'thumb')?' imageOverlayRight':'');D.style.visibility='hidden';B.style.position='relative';if (B.nodeName.IEquals('a')&&!FCKBrowserInfo.IsIE) {var E=parseInt(B.firstChild.offsetHeight/2);D.style.top=(-E+8)+'px';};B.appendChild(D);D.innerHTML='<span class="videoOverlayEdit" onclick="FCK.VideoEdit('+A+')">'+FCKLang.DlgSelectBtnModify+'</span><span class="videoOverlayRemove" onclick="FCK.VideoRemove('+A+')">'+FCKLang.DlgSelectBtnDelete+'</span>';if (FCK.UseContentEditable) {D.innerHTML+='<span class="videoOverlayDrag">move</span>';};FCKTools.AddEventListener(B,'mouseover',function(e) {D.style.visibility='visible';});FCKTools.AddEventListener(B,'mouseout',function(e) {D.style.visibility='hidden';});};FCK.VideoGalleryAdd=function(A) {var B=FCK.GetFreeRefId();FCK.log('adding new <videogallery> #'+B+': '+A);FCK.Track('/video/add/gallery');FCK.wysiwygData[B]={'type':'hook','name':'videogallery','description':A};placeholder=FCK.EditorDocument.createElement('INPUT');placeholder.className='wysiwygDisabled wysiwygVideogallery';placeholder.type='button';placeholder.value='<videogallery>';placeholder.setAttribute('refid',B);placeholder.setAttribute('_fck_type','videogallery');FCK.InsertElement(placeholder);FCK.VideoSetupGalleryPlaceholder(placeholder);};FCK.VideoSetupGalleryPlaceholder=function(A) {FCKTools.AddEventListener(A,'click',FCK.VideoGalleryClick);};FCK.VideoGalleryClick=function(e) {var e=FCK.YE.getEvent(e);var A=FCK.YE.getTarget(e);FCK.YE.stopEvent(e);var B=parseInt(A.getAttribute('refid'));if (typeof window.parent.VET_show!='undefined') {window.parent.VET_show(B,1);}};FCK.VideoGalleryUpdate=function(A,B) {var C=FCK.wysiwygData[A];if (C&&(C.type=='hook')) {var D=C.description;D=D.substr(14,D.length-29);D=FCK.YAHOO.Tools.trim(D);C.description="<videogallery>\n"+D+"\n"+B+"\n</videogallery>";FCK.log('<videogallery> #'+A+' updated to: '+C.description);}};
FCK.WikiaToolbarShowTooltip=function(A) {FCK.log('showing toolbar tooltip');var B=window.parent.document;var C=B.createElement('DIV');C.id='wysiwygToolbarTooltip';B.body.appendChild(C);C.innerHTML=A;C.style.top=parseInt(FCK.YD.getY('editform')-30)+'px';C.style.left='500px';FCK.YE.addListener('wysiwygToolbarTooltipClose','click',function(e) {FCK.YD.get('wysiwygToolbarTooltip').style.display='none';window.parent.sajax_do_call('WysiwygToolbarRemoveTooltip',[],function() {});});};var WikiaSeparator=function(A) { this.Bucket=A;};WikiaSeparator.prototype.Create=function(A) {};var WikiaToolbar=function() {this.Buckets=window.parent.wysiwygToolbarBuckets;this.CurrentBucket=0;};WikiaToolbar.prototype=new FCKToolbar;WikiaToolbar.prototype.AddSeparator=function() {var A=this.Buckets[this.CurrentBucket++];this.AddItem(new WikiaSeparator({'name':A,'last':(this.CurrentBucket==this.Buckets.length)}));};WikiaToolbar.prototype.Create=function(A) {FCK.log('toolbar rendering');var B=FCKTools.GetElementDocument(A);var C=B.createElement('TABLE');C.id='fck_toolbar';C.className='reset';A.appendChild(C);A.style.display='none';this.Toolbar=C;FCKTools.AppendStyleSheet(B,window.parent.wgExtensionsPath+'/wikia/Wysiwyg/fckeditor/editor/plugins/toolbar/toolbar.css');if (FCKBrowserInfo.IsIE) {FCKTools.AppendStyleSheet(B,window.parent.wgExtensionsPath+'/wikia/Wysiwyg/fckeditor/editor/plugins/toolbar/toolbar_ie.css');};var D=new FCK.YAHOO.util.Element('page_bar');var E=D.getStyle('backgroundColor')||'#efefde';C.style.color=D.getStyle('color')||'#000';A.style.backgroundColor=E;var F=C.insertRow(-1);var G=false;var H=0;var I=0;for (var i=0;i<this.Items.length;i++) {var J=this.Items[i];if (J.Bucket) {if (G&&H>1) {G.style.maxWidth=(H*27)+'px';this.addBucketIEFixes(G);};var K=F.insertCell(-1);K.innerHTML='<div class="clearfix" style="background-color: '+E+'"><label title="'+J.Bucket.name+'">'+J.Bucket.name+'</label><ul class="clearfix"></ul></div>';if (J.Bucket.last) {K.className='last';};G=K.getElementsByTagName('ul')[0];H=0;G.id='fck_toolbar_bucket_'+(++I);}else {J.Create(G);H++;}};this.addBucketIEFixes(G);if (G&&H>1) {G.style.maxWidth=(H*27)+'px';};if (typeof window.parent.wysiwygToolbarTooltip!='undefined') {FCK.WikiaToolbarShowTooltip(window.parent.wysiwygToolbarTooltip);}else {FCK.log('not showing toolbar tooltip');}};WikiaToolbar.prototype.addBucketIEFixes=function(A) {if (!FCKBrowserInfo.IsIE) {return;};var B;FCKTools.AddEventListener(A.parentNode.parentNode,'mouseover',function(e) {if (FCK.EditMode!=0) {return;};var C=A.id.split('_').pop();if (A.getElementsByTagName('li').length*27>A.offsetWidth) {A.parentNode.style.height='auto';};setTimeout("var node = document.getElementById('fck_toolbar_bucket_"+C+"').parentNode;node.style.height = node.offsetHeight + 'px'",50);clearTimeout(B);});FCKTools.AddEventListener(A.parentNode.parentNode,'mouseout',function(e) {if (FCK.EditMode!=0) {return;};A.parentNode.style.height='49px';});};FCK.WikiaUsingNewToolbar=true;WikiaToolbar.prototype.WikiaSwitchToolbar=function(A) {var B=window.parent.document.getElementById('toolbar');var C=window.parent.document.getElementById('wpTextbox1___Frame');if (A) {B.style.top=(C.offsetTop+14)+'px';B.style.left='12px';B.style.visibility='visible';this.Toolbar.className='toolbarSource';}else {B.style.visibility='hidden';this.Toolbar.className='toolbarWysiwyg';}};WikiaToolbar.prototype.AddItem=function(A){return this.Items[this.Items.length]=A;};FCKToolbar.prototype=new WikiaToolbar;var WikiaButtonUI=function(A,B,C,D,E,F){this.Name=A;this.Label=B||A;this.Tooltip=C||this.Label;this.Style=E||0;this.State=F||0;this.Icon=new FCKIcon(D);this.IconsPath=window.parent.wgExtensionsPath+'/wikia/Wysiwyg/fckeditor/editor/plugins/toolbar/icons/';this.Icons={'H2':'text_heading_2.png','H3':'text_heading_3.png','Bold':'text_bold.png','Italic':'text_italic.png','Underline':'text_underline.png','StrikeThrough':'text_strikethrough.png','Normal':'icon_normal.png','Pre':'icon_pre.png','Indent':'text_indent.png','Outdent':'text_indent_remove.png','InsertUnorderedList':'text_list_bullets.png','InsertOrderedList':'text_list_numbers.png','Link':'link.png','Unlink':'link_break.png','AddImage':'photo.png','AddVideo':'film.png','Table':'table.png','Tildes':'icon_signature.png','Undo':'arrow_undo.png','Redo':'arrow_redo.png','Widescreen':'icon_widescreen.png','Source':'application_xp_terminal.png'};if (FCK.IECleanup) FCK.IECleanup.AddItem(this,FCKToolbarButtonUI_Cleanup);};WikiaButtonUI.prototype=new FCKToolbarButtonUI;WikiaButtonUI.prototype.Create=function(A){if (this.Name=='Source') {this.Style=0;};if (this.Icons[this.Name]) {src=this.IconsPath+this.Icons[this.Name];this.Icon=new FCKIcon(src);};var B=FCKTools.GetElementDocument(A);var C=this.MainElement=B.createElement('LI');C.title=this.Tooltip;C.id='fck_toolbar_item_'+this.Name.toLowerCase();if (FCKBrowserInfo.IsGecko) C.onmousedown=FCKTools.CancelEvent;FCKTools.AddEventListenerEx(C,'mouseover',WikiaButtonUI_OnMouseOver,this);FCKTools.AddEventListenerEx(C,'mouseout',WikiaButtonUI_OnMouseOut,this);FCKTools.AddEventListenerEx(C,'click',WikiaButtonUI_OnClick,this);this.ChangeState(this.State,true);if (this.Style==0&&!this.ShowArrow){C.appendChild(this.Icon.CreateIconElement(B));}else{var D=C.appendChild(B.createElement('TABLE'));D.cellPadding=0;D.cellSpacing=0;var E=D.insertRow(-1);var F=E.insertCell(-1);if (this.Style==0||this.Style==2) {F.appendChild(this.Icon.CreateIconElement(B));}else {F.appendChild(this._CreatePaddingElement(B));};if (this.Style==1||this.Style==2){F=E.insertCell(-1);F.className='TB_Button_Text';F.noWrap=true;F.appendChild(B.createTextNode(this.Label));};if (this.ShowArrow){if (this.Style!=0){E.insertCell(-1).appendChild(this._CreatePaddingElement(B));};F=E.insertCell(-1);var G=F.appendChild(B.createElement('IMG'));G.src=FCKConfig.SkinPath+'images/toolbar.buttonarrow.gif';G.width=5;G.height=3;};F=E.insertCell(-1);F.appendChild(this._CreatePaddingElement(B));};A.appendChild(C);};WikiaButtonUI.prototype.ChangeState=function(A,B){if (!B&&this.State==A) return;var e=this.MainElement;if (!e) return;switch (parseInt(A,10)){case 0:e.className='fck_button_off';break;case 1:e.className='fck_button_on';break;case -1:e.className='fck_button_disabled';break;};this.State=A;if (this.Name=='Source') {e.title=(this.State==1)?FCKLang.Wysiwyg:FCKLang.Source;}};function WikiaButtonUI_OnMouseOver(A,B){if (B.State==0) {this.className='fck_button_off_over';}else if (B.State==1) {this.className='fck_button_on_over';};var C=this.parentNode.parentNode.firstChild;C.innerHTML=B.Label;};function WikiaButtonUI_OnMouseOut(A,B){if (B.State==0) {this.className='fck_button_off';}else if (B.State==1) {this.className='fck_button_on';};var C=this.parentNode.parentNode.firstChild;C.innerHTML=C.title;};function WikiaButtonUI_OnClick(A,B){if (B.OnClick&&B.State!=-1) B.OnClick(B);};FCKToolbarButtonUI.prototype=new WikiaButtonUI;var WikiaCombo=function(){this.Items={};};WikiaCombo.prototype=FCKSpecialCombo.prototype;WikiaCombo.prototype.AddItem=function(A,B,C,D){this.Items[A.toString()]={'html':B,'label':C,'bold':D?true:false};};WikiaCombo.prototype.Create=function(A){var B=FCKTools.GetElementDocument(A);this.Select=B.createElement('SELECT');A.appendChild(this.Select);this.Select.style.width=this.FieldWidth+'px';this.Select.appendChild(B.createElement('OPTION'));for (Item in this.Items) {var C=B.createElement('OPTION');C.value=Item;C.innerHTML=this.Items[Item].html;if (this.Items[Item].bold) {C.style.fontWeight='bold';};this.Select.appendChild(C);};this.Select.parentNode.parentNode.style.overflow='visible';FCKTools.AddEventListenerEx(this.Select,'change',WikiaCombo_OnClick,[this]);};WikiaCombo.prototype.SetEnabled=function(A) {this.Select.disabled=A?false:true;};WikiaCombo.prototype.SetLabel=function(A) {};function WikiaCombo_OnClick(A,B) {var C=B.Select.options[B.Select.selectedIndex].value;B.Select.selectedIndex=0;FCK.log('WikiaCombo: selected '+C);var D=FCKCommands.GetCommand(B.CommandName);D.Execute(C);};FCKSpecialCombo.prototype=new WikiaCombo;var StyleCommand=function(A,B) {this.Name=B;this.Command=new FCKCoreStyleCommand(A);this.IsActive=false;this.IsDisabled=false;if (A=='h2'||A=='h3'||A=='pre'||A=='p') {this.disableWhenInsideList=true;FCK.log(A+' will be disabled inside list');};FCKStyles.AttachStyleStateChange(this.Command.StyleName,this._OnStyleStateChange,this);};StyleCommand.prototype={IsInsideList:function() {var A=FCKSelection.GetBoundaryParentElement(true);var B=A;if (B&&B.nodeName.IEquals(['ul','ol','li'])) {return true;}else {return false;}},Execute:function() {this.Command.Execute();},GetState:function() {if (FCK.EditMode!=0) {return -1;}else if (this.IsDisabled) {return -1;}else {return this.IsActive?1:0;}},_OnStyleStateChange:function(A,B) {this.IsActive=B;this.IsDisabled=(this.disableWhenInsideList&&this.IsInsideList());if (B) {FCK.log('current style: '+this.Name);};var C=FCK.ToolbarSet.Items;for (i=0;i<C.length;i++) {C[i].RefreshState();}}};var WideScreenToggle=function() {this.toggleWideScreenLink=window.parent.document.getElementById("toggleWideScreen");this.isActive=FCK.YD.hasClass(window.parent.document.body,'editingWide');this.listener=false;};WideScreenToggle.prototype={Toggle:function() {if (this.listener) {this.listener(true);return true;};if (this.toggleWideScreenLink&&FCK.YE.getListeners) {this.listener=FCK.YE.getListeners(this.toggleWideScreenLink).pop().fn;this.listener(true);return true;}else {return false;}},Execute:function() {this.Toggle();this.isActive=!this.isActive;var A=FCK.ToolbarSet.Items;for (i=0;i<A.length;i++) {A[i].RefreshState();}},GetState:function() {return this.isActive?1:0;}};FCKCommands.RegisterCommand('H2',new StyleCommand('h2','Heading 2'));FCKToolbarItems.RegisterItem('H2',new FCKToolbarButton('H2','Section Heading'));FCKCommands.RegisterCommand('H3',new StyleCommand('h3','Heading 3'));FCKToolbarItems.RegisterItem('H3',new FCKToolbarButton('H3','Sub Heading'));FCKCommands.RegisterCommand('Pre',new StyleCommand('pre','Preformatted'));FCKToolbarItems.RegisterItem('Pre',new FCKToolbarButton('Pre','Preformatted'));FCKCommands.RegisterCommand('Normal',new StyleCommand('p','Normal Text'));FCKToolbarItems.RegisterItem('Normal',new FCKToolbarButton('Normal','Remove Heading'));FCKCommands.RegisterCommand('Widescreen',new WideScreenToggle());FCKToolbarItems.RegisterItem('Widescreen',new FCKToolbarButton('Widescreen','Toggle widescreen'));
