<html>
<body>
<!-- Jquery is required for the API itself -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<!-- Jquery UI is just used for this test page -->
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>
<!-- Tabs ripped from http://jqueryui.com/demos/tabs/ -->
<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/cupertino/jquery-ui.css"/>
<link rel="stylesheet" type="text/css" href="main.css"/>
<script type="text/javascript">
	$(function() {
		$("#tabs").tabs({
			collapsible: true
		});
	});
</script>
<!-- End tabs setup -->
<script src="../JavascriptAPI/Mediawiki.js"></script>
<script src="main.js"></script>
<script>
// Set up the cookie prefix, which is set in Mediawiki as $wgCookiePrefix
Mediawiki.cookiePrefix = "wikicities";
var match = window.location.search.match(/js_debug=([0-9])/);
if (match !== null){
	Mediawiki.debugLevel = match[1];
}
</script>
<!-- End Mediawiki API setup -->

<div id="tabs">
	<ul>
		<li><a href="#tabs-0">0. Logged In?</a></li>
		<li><a href="#tabs-1">1. Add a description</a></li>
		<li><a href="#tabs-2">2. Add a logo</a></li>
		<li><a href="#tabs-3">3. Pick Theme</a></li>
		<li><a href="#tabs-4">4. Create First pages</a></li>
		<li><a href="#tabs-5">5. Done</a></li>
	</ul>

<div id="tabs-0">
        <div id="loginForm">
        <form onSubmit="return handleLoginForm(this)">
        <label class="formLabel">Username:</label> <input type="text" name="lgname" size="10">
        <label class="formLabel">Password:</label> <input type="password" name="lgpassword" size="10"> <br />
        <input type="submit" value="Login">
        </form>
        </div>

        <div id="logoutForm" style="display:none">
                You are logged in.
                <input type="button" value="logout" onClick="return Mediawiki.logout(handleLogoutForm)"/>
        </div>



        <script>
        function handleLoginForm(f){
                try { 
                        Mediawiki.apiUser = f.lgname.value;
                        Mediawiki.apiPass = f.lgpassword.value;
                        Mediawiki.login(loginWorked, apiFailed);
                } catch (e) {
                        Mediawiki.updateStatus( "Error logging in:" + Mediawiki.print_r(e));    
                }
                return false; // Return false so that the form doesn't submit
        }
        function loginWorked (){
                $("#loginForm").fadeOut();
                $("#logoutForm").fadeIn();
        }

        function apiFailed(msg){
                alert("Api call returned an error: " + msg);
        }
        function handleLogoutForm(f){
                $("#logoutForm").fadeOut();
                $("#loginForm").fadeIn();
        }

        if (Mediawiki.isLoggedIn()){
                loginWorked();
        }
        </script>
</div>


<!-- ##############  Add a description to main page ############## -->
<div id="tabs-1">
	<form onSubmit="return handleDescriptionForm(this)">
	<div id="desc_form_html">
	Enter a description for the main page:<br />
	<textarea name="desc" rows="10" cols="60" id="desc_textarea"></textarea><br />
	<input type="submit" value="Save Description"/> <br />
	</form>
	</div>

	<script>

	// Find where main page redirects too
	var mainPageEnd = Mediawiki.followRedirect("Main Page"); 

	// Bring in the main page 
	Mediawiki.pullArticleContent(mainPageEnd,	
		function (result){ $("#desc_textarea").val(result);},
		{"rvsection":0}
	);

	handleDescriptionForm = function(f){
	  try {
	     // Save the article
	     Mediawiki.editArticle({
		  "title": mainPageEnd,
		  "summary": "Adding initial description to " + mainPageEnd, /* i18n */
		  "section": 0,
		  "text": $("#desc_textarea").val()}, 
		  function(){
			  NewWikiBuilder.updateStatus("Description Saved"); /* i18n */
		  },
		  NewWikiBuilder.handleError);
	  } catch (e) {
		  Mediawiki.updateStatus("Error saving description.");
		  Mediawiki.debug(Mediawiki.print_r(e));
	  }

	  return false; // Return false so that the form doesn't submit
	};
	</script>
</div>

<!-- ############## Add a logo ############ -->
<div id="tabs-2">
	<div id="logo_form_html">
	<!-- Hidden iframe to handle the file upload -->
	<iframe id="hidden_iframe" src="about:blank" style="display:none" name="hidden_iframe" onLoad="NewWikiBuilder.iframeFormUpload(this)"></iframe>
	<form action="/api.php" method="post" enctype="multipart/form-data" target="hidden_iframe" onSubmit='Mediawiki.updateStatus("Uploading image...")'>
	<input type="hidden" name="action" value="uploadlogo">	
	<input type="hidden" name="format" value="xml">	
	<input id="logo_article" type="hidden" name="title" value="Wiki.png">	
	<div id="desc_form_html">
	Upload a logo
	<input type="file" name="logo_file"><br />
	<p>
	<input type="submit" value="Preview" onClick="this.form.title.value='Wiki-Preview.png'"/> 
	<input type="submit" value="Save" onClick="this.form.title.value='Wiki.png'"/> 
	</form>
	</div>

	<!-- Christian: help. Float! -->
	<div style="float: right">
	<!-- TODO: API call to get image url -->
	<div id="logo_current"></div>
	<br />
	<div id="logo_preview">
		Logo preview
	</div>
	</div>

	<script> 
	normalizedLogo = Mediawiki.getNormalizedTitle(Mediawiki.$("logo_article").value);
        url = Mediawiki.getImageUrl(normalizedLogo) + '?' + Math.random();
        $("#logo_current").css("backgroundImage", "url(" + url + ")");
	</script>

</div>

<!-- ############## Pick Theme ############## -->

<div id="tabs-3">
	Pick a theme
</div>

<!-- ############## Create first pages ############## -->

<div id="tabs-4">
	Create your first pages
</div>

<!-- ############## Create first pages ############## -->

<div id="tabs-5">
	Done
</div>

</div> <!-- /div id=tabs -->
