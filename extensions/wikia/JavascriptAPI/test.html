<html>
<body>
<!-- Jquery is required for the API itself -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<!-- Jquery UI is just used for this test page -->
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>
<!-- Tabs ripped from http://jqueryui.com/demos/tabs/ -->
<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/cupertino/jquery-ui.css"/>
<link rel="stylesheet" type="text/css" href="style.css"/>
<script type="text/javascript">
	$(function() {
		$("#tabs").tabs({
			collapsible: true
		});
	});
</script>
<!-- End tabs setup -->
<script src="Mediawiki.js"></script>
<script>
// Set up the cookie prefix, which is set in Mediawiki as $wgCookiePrefix
Mediawiki.cookiePrefix = "wikicities";
</script>
<!-- End Mediawiki API setup -->

<div id="tabs">
	<ul>
		<li><a href="#tabs-1">Login/</a></li>
		<li><a href="#tabs-2">Create Article</a></li>
		<li><a href="#tabs-3">Pull Article</a></li>
	</ul>

<div id="tabs-1">
	<div id="loginForm">
	<form onSubmit="return handleLoginForm(this)">
	<label class="formLabel">Username:</label> <input type="text" name="lgname" size="10">
	<label class="formLabel">Password:</label> <input type="password" name="lgpassword" size="10"> <br />
	<input type="submit" value="Login">
	</form>
	</div>

	<div id="logoutForm" style="display:none">
		You are logged in.
		<input type="button" value="logout" onClick="return Mediawiki.logout(handleLogoutForm)"/>
	</div>



	<script>
	function handleLoginForm(f){
		try { 
			Mediawiki.apiUser = f.lgname.value;
			Mediawiki.apiPass = f.lgpassword.value;
			Mediawiki.login(loginWorked, apiFailed);
		} catch (e) {
			Mediawiki.updateStatus( "Error logging in:" + Mediawiki.print_r(e));	
		}
		return false; // Return false so that the form doesn't submit
	}
	function loginWorked (){
		$("#loginForm").hide();
		$("#logoutForm").show();
	}

	function apiFailed(msg){
		alert("Api call returned an error: " + msg);
	}
	function handleLogoutForm(f){
		$("#logoutForm").hide();
		$("#loginForm").show();
	}

	if (Mediawiki.isLoggedIn()){
		loginWorked();
	}
	</script>
</div>

<!-- ############## Create an article ############## -->
<div id="tabs-2">
	<form onSubmit="return handleCreateArticle(this)">
	Create a new article named: <input type="text" name="new_title"> <input type="submit" value="Create">
	</form>
	<div id="articleStatus"></div>
	<script>
	function handleCreateArticle (f){
		try { 
			normalizedTitle = Mediawiki.getNormalizedTitle(f.new_title.value);
			f.new_title.value = normalizedTitle;
			Mediawiki.editArticle({"title": normalizedTitle, "createonly": true, "summary": "testing new api", "text": "page automatically created using Nick's api"}, createArticleSuccess, apiFailed);
		} catch (e) {
			Mediawiki.updateStatus( "Error creating article:" + Mediawiki.print_r(e));	
		}
		return false; // Return false so that the form doesn't submit
	}
	function createArticleSuccess(){
		alert("Article created");
		$("#articleStatus").html("Article created! <a href='/wiki/" + normalizedTitle + "'>" + normalizedTitle + "</a> " + 
			"<input type=button value=delete onClick='Mediawiki.deleteArticle(\"" + normalizedTitle + "\", null, deleteArticleSuccess, apiFailed)'/>");
	}
	function deleteArticleSuccess(){
		alert(normalizedTitle + " deleted");
		$("#articleStatus").hide();	
	}
	</script>
</div>

<!-- ############## Pull down an article ############## -->

<div id="tabs-3">
	<form onSubmit="return handlePullArticle(this)" id="pullArticleForm">
		<input type="text" name="articleName" value="Main_Page" id="articleName">
		<input type="submit" value="Pull Article"/> <br />
		<input type="checkbox" name="redirects"/> Resolve Redirects <br />
		<input type="checkbox" name="parseText"/> Return HTML (instead of Mediawiki Text)
	</form>
	<div id="pulledArticle">
	</div>

	<script>
	function fillInArticle(result){
		console.log("in fillInArticle"); 
		var html;
		if (result === null){
			html = Mediawiki.$("pullArticleForm").articleName.value + " does not exist";
		} else if (document.getElementById("pullArticleForm").parseText.checked){
			html = result;
		} else {
			html  = '<pre>' + result + '</pre>';
		}
		Mediawiki.$("pulledArticle").innerHTML = html;
	}

	function handlePullArticle (f) {
		try { 
		var articleName = f.articleName.value;
		var cleanName = Mediawiki.getNormalizedTitle(articleName);
		Mediawiki.$("pullArticleForm").articleName.value = cleanName;

		if (f.parseText.checked) {
			Mediawiki.pullArticleHtml(cleanName, fillInArticle);
		} else {
			var options = {};
			if (f.redirects.checked) {
				options.redirects = true;
			}
			Mediawiki.pullArticleContent(cleanName, fillInArticle, options);
		}
		} catch (e) {
			Mediawiki.error("Error pulling article: " + Mediawiki.print_r(e));
		}

		return false; // So the form doesn't submit
	}
	</script>

</div>

</div> <!-- /div id=tabs -->
